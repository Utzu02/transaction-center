name: Deploy frontend & backend to Vercel

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Vercel CLI
        run: npm ci -g vercel@latest || npm i -g vercel@latest

      - name: Deploy backend to Vercel
        id: deploy_backend
        working-directory: backend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -e
          # Deploy and capture raw CLI output (avoid --json which may not be supported in some CLI versions)
          OUT=$(vercel --prod --token "$VERCEL_TOKEN" --confirm 2>&1 || true)
          echo "$OUT" > vercel_backend_out.txt
          echo "--- vercel backend output (tail) ---"
          tail -n 200 vercel_backend_out.txt || true
          # Try to extract the deployment URL (first vercel.app URL in output)
          DEPLOY_URL=$(echo "$OUT" | grep -oE 'https?://[^ ]+vercel.app' | head -n1 || true)
          echo "deploy_url=$DEPLOY_URL"
          # If we couldn't extract a URL, leave it empty (alias step will handle fallback)
          echo "backend_deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "BACKEND_DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV

      - name: Alias backend deployment to your stable domain
        if: always()
        working-directory: backend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          DEPLOY_URL: ${{ steps.deploy_backend.outputs.backend_deploy_url }}
        run: |
          set -e
          # Use the stable domain that you control for this project (from your Dashboard)
          STABLE_DOMAIN="backend-self-xi-87.vercel.app"
          echo "Stable domain to use: $STABLE_DOMAIN"
          # If we have a deployment URL, attempt to alias it to the stable domain.
          if [ -n "$DEPLOY_URL" ]; then
            echo "Attempting to alias $DEPLOY_URL -> $STABLE_DOMAIN"
            # Do not use unsupported flags; if alias fails, continue and still use the stable domain
            if vercel alias "$DEPLOY_URL" "$STABLE_DOMAIN" --token "$VERCEL_TOKEN" 2>&1; then
              echo "Alias succeeded: $STABLE_DOMAIN"
            else
              echo "Alias command failed (ok if alias already exists or permission denied)." 
            fi
          else
            echo "No deploy URL found from CLI output; skipping alias command."
          fi
          # Regardless of alias result, set BACKEND_URL to the stable domain so the workflow uses it
          echo "backend_url=https://$STABLE_DOMAIN" >> $GITHUB_OUTPUT
          echo "BACKEND_URL=https://$STABLE_DOMAIN" >> $GITHUB_ENV

      - name: Build frontend locally (CI)
        id: build_frontend
        working-directory: frontend
        env:
          BACKEND_URL: "https://backend-self-xi-87.vercel.app/"
        run: |
          set -e
          echo "Using backend URL for build: $BACKEND_URL"
          # install all deps (including devDependencies) and build with the backend URL
          npm ci
          # export the Vite env var for the build
          export VITE_API_BASE_URL="$BACKEND_URL"
          npm run build

      - name: Deploy built frontend (dist/) to Vercel
        id: deploy_frontend
        working-directory: frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -e
          # Deploy the already-built static output to Vercel to avoid running 'vite build' on Vercel
          # Also pass BACK_URL and VITE_API_BASE_URL so the frontend deployment receives the backend URL
          vercel --prod --token "$VERCEL_TOKEN" --confirm --json --env BACK_URL="$BACKEND_URL" --env VITE_API_BASE_URL="$BACKEND_URL" dist > vercel_frontend_out.json || true
          cat vercel_frontend_out.json
          FRONTEND_URL=$(jq -r 'if type=="array" then (.[0].url // .[0].inspectUrl // .[0].url) else .url end' vercel_frontend_out.json || true)
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Install jq for tests
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Smoke tests (backend + frontend)
        env:
          FRONTEND_URL: "https://frontend-cyan-six-47.vercel.app/"
          BACKEND_URL: "https://backend-self-xi-87.vercel.app/"
          VERCEL_BYPASS: ${{ secrets.VERCEL_BYPASS }}
        run: |
          set -e
          echo "Frontend URL: $FRONTEND_URL"
          echo "Backend URL: $BACKEND_URL"
          # Wait a few seconds for the deployments to warm up
          sleep 5
          # If a Vercel protection bypass token is provided, append it to requests
          SUFFIX=""
          if [ -n "$VERCEL_BYPASS" ]; then
            SUFFIX="?x-vercel-set-bypass-cookie=true&x-vercel-protection-bypass=$VERCEL_BYPASS"
            echo "Using Vercel bypass token for smoke tests"
          fi

          echo "Checking backend /api/health"
          curl -sS "$BACKEND_URL/api/health$SUFFIX" || true
          echo "\nChecking backend /api/transactions?limit=2"
          curl -sS "$BACKEND_URL/api/transactions?limit=2$SUFFIX" || true
          echo "\nTesting POST /api/predict"
          curl -sS -X POST -H 'Content-Type: application/json' -d '{"amount":"1200"}' "$BACKEND_URL/api/predict$SUFFIX" || true
          echo "\nChecking frontend root status code"
          HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" "$FRONTEND_URL$SUFFIX" || true)
          echo "Frontend HTTP status: $HTTP_CODE"

      - name: Output deployed URLs
        run: |
          echo "Backend URL: https://backend-self-xi-87.vercel.app/"
          echo "Frontend URL: https://frontend-cyan-six-47.vercel.app/"
