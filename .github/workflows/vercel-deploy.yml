name: Deploy frontend & backend to Vercel

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Vercel CLI
        run: npm ci -g vercel@latest || npm i -g vercel@latest

      - name: Deploy backend to Vercel
        id: deploy_backend
        working-directory: backend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -e
          # Use JSON output to reliably capture the production URL
          vercel --prod --token "$VERCEL_TOKEN" --confirm --json > vercel_backend_out.json || true
          cat vercel_backend_out.json
          # JSON may be an array; try to parse the first object's url or .url field
          BACKEND_URL=$(jq -r 'if type=="array" then (.[0].url // .[0].inspectUrl // .[0].url) else .url end' vercel_backend_out.json || true)
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT

      - name: Alias backend deployment to stable subdomain (optional)
        if: always()
        working-directory: backend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          BACKEND_URL: "https://backend-self-xi-87.vercel.app/"
        run: |
          set -e
          # Choose a stable alias under your Vercel team. Change if you prefer another name.
          ALIAS_NAME="api-transaction-center.utzus-projects.vercel.app"
          echo "Attempting to alias $BACKEND_URL -> $ALIAS_NAME"
          # Try to alias; if it fails, continue and keep using the original BACKEND_URL
          if vercel alias "$BACKEND_URL" "$ALIAS_NAME" --token "$VERCEL_TOKEN" --yes; then
            echo "Alias succeeded: $ALIAS_NAME"
            echo "backend_url=$ALIAS_NAME" >> $GITHUB_OUTPUT
            echo "BACKEND_URL=$ALIAS_NAME" >> $GITHUB_ENV
          else
            echo "Alias failed or not allowed; keeping original backend URL: $BACKEND_URL"
            echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
            echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
          fi

      - name: Build frontend locally (CI)
        id: build_frontend
        working-directory: frontend
        env:
          BACKEND_URL: "https://backend-self-xi-87.vercel.app/"
        run: |
          set -e
          echo "Using backend URL for build: $BACKEND_URL"
          # install all deps (including devDependencies) and build with the backend URL
          npm ci
          # export the Vite env var for the build
          export VITE_API_BASE_URL="$BACKEND_URL"
          npm run build

      - name: Deploy built frontend (dist/) to Vercel
        id: deploy_frontend
        working-directory: frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -e
          # Deploy the already-built static output to Vercel to avoid running 'vite build' on Vercel
          # Also pass BACK_URL and VITE_API_BASE_URL so the frontend deployment receives the backend URL
          vercel --prod --token "$VERCEL_TOKEN" --confirm --json --env BACK_URL="$BACKEND_URL" --env VITE_API_BASE_URL="$BACKEND_URL" dist > vercel_frontend_out.json || true
          cat vercel_frontend_out.json
          FRONTEND_URL=$(jq -r 'if type=="array" then (.[0].url // .[0].inspectUrl // .[0].url) else .url end' vercel_frontend_out.json || true)
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT

      - name: Install jq for tests
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Smoke tests (backend + frontend)
        env:
          FRONTEND_URL: "https://frontend-cyan-six-47.vercel.app/"
          BACKEND_URL: "https://backend-self-xi-87.vercel.app/"
          VERCEL_BYPASS: ${{ secrets.VERCEL_BYPASS }}
        run: |
          set -e
          echo "Frontend URL: $FRONTEND_URL"
          echo "Backend URL: $BACKEND_URL"
          # Wait a few seconds for the deployments to warm up
          sleep 5
          # If a Vercel protection bypass token is provided, append it to requests
          SUFFIX=""
          if [ -n "$VERCEL_BYPASS" ]; then
            SUFFIX="?x-vercel-set-bypass-cookie=true&x-vercel-protection-bypass=$VERCEL_BYPASS"
            echo "Using Vercel bypass token for smoke tests"
          fi

          echo "Checking backend /api/health"
          curl -sS "$BACKEND_URL/api/health$SUFFIX" || true
          echo "\nChecking backend /api/transactions?limit=2"
          curl -sS "$BACKEND_URL/api/transactions?limit=2$SUFFIX" || true
          echo "\nTesting POST /api/predict"
          curl -sS -X POST -H 'Content-Type: application/json' -d '{"amount":"1200"}' "$BACKEND_URL/api/predict$SUFFIX" || true
          echo "\nChecking frontend root status code"
          HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" "$FRONTEND_URL$SUFFIX" || true)
          echo "Frontend HTTP status: $HTTP_CODE"

      - name: Output deployed URLs
        run: |
          echo "Backend URL: https://backend-self-xi-87.vercel.app/"
          echo "Frontend URL: https://frontend-cyan-six-47.vercel.app/"
